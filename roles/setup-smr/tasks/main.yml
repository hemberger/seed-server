---
# tasks file for setup-smr

- name: Checkout git repository 'smrealms/dockerize'
  git:
    repo: https://github.com/smrealms/dockerize.git
    dest: "{{ smr_home_dir }}"
    version: master

- name: Create acme.json for traefik
  file:
    path: "{{ smr_home_dir }}/traefik/acme.json"
    state: touch
    mode: 0600

- name: Copy and decrypt configuration files
  copy:
    src: files/
    dest: "{{ smr_home_dir }}"

- name: Restore backups from s3
  command: docker-compose run --rm -e PARAMS=--skip-existing backup-s3 get
  args:
    chdir: "{{ smr_home_dir }}"

- name: Fix file permissions for player images
  file:
    path: "{{ smr_home_dir }}/player-upload"
    recurse: yes
    owner: www-data
    group: www-data

- name: Generate MySql password
  set_fact:
    mysql_pass: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}"

- name: Put MySql password in config file
  replace:
    path: "{{ smr_home_dir }}/config/SmrMySqlSecrets.inc"
    regexp: "private static \\$password = '.*';"
    replace: "private static $password = '{{ mysql_pass }}';"

- name: Put MySql password in env file
  replace:
    path: "{{ smr_home_dir }}/.env"
    regexp: "MYSQL_PASSWORD=.*"
    replace: "MYSQL_PASSWORD={{ mysql_pass }}"

- name: Start mysql server to restore database
  command: docker-compose up --detach mysql
  args:
    chdir: "{{ smr_home_dir }}"

- name: Allow passwordless login to mysql via commandline
  shell: docker-compose exec -T mysql sh -c 'echo "[client]\nhost=localhost\nuser=root\npassword=$MYSQL_ROOT_PASSWORD" > ${HOME}/.my.cnf'
  args:
    chdir: "{{ smr_home_dir }}"

- name: Wait for mysql to start
  pause:
    seconds: 10

- name: Restore database 'smr_live'
  command: ./restore_smr_live.sh
  args:
    chdir: "{{ smr_home_dir }}/backup"
    creates: "{{ smr_home_dir }}/data/db/smr_live/game.frm"

- name: Restore database 'smr_12_history'
  command: ./restore_smr_archive.sh smr_12_history.sql.bz2
  args:
    chdir: "{{ smr_home_dir }}/backup"
    creates: "{{ smr_home_dir }}/data/db/smr_12_history/game.frm"

- name: Restore database 'smr_classic_history'
  command: ./restore_smr_archive.sh smr_classic_history.sql.bz2
  args:
    chdir: "{{ smr_home_dir }}/backup"
    creates: "{{ smr_home_dir }}/data/db/smr_classic_history/game.frm"

- name: Update password to MySql user 'smr' for when changed on redeploy
  shell: echo "ALTER USER smr IDENTIFIED BY '{{ mysql_pass }}';" | docker exec -i smr-mysql mysql

- name: Grant permissions to smr_12_history
  shell: echo "GRANT SELECT ON smr_12_history.* TO smr;" | docker exec -i smr-mysql mysql

- name: Grant permissions to smr_classic_history
  shell: echo "GRANT SELECT ON smr_classic_history.* TO smr;" | docker exec -i smr-mysql mysql

- name: Start SMR and related services
  command: docker-compose up --detach smr discord irc
  args:
    chdir: "{{ smr_home_dir }}"

- name: Create cron entry for database backup
  cron:
    name: Database backups
    hour: 9
    minute: 0
    job: cd {{ smr_home_dir }} && nice -n 19 ./backup/backup_cron.sh && docker-compose run --rm backup-s3 sync > /dev/null

- name: Create cron entry for docker cleanup
  cron:
    name: docker cleanup
    special_time: daily
    job: docker image prune -f > /dev/null
